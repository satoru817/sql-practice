ä»¥ä¸‹ã®åˆ†æžã‚’è¡Œã†SQLã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. å°‚é–€åˆ†é‡Žã«ã€Œæ¶ˆåŒ–å™¨ç§‘ã€ã‚’å«ã‚€åŒ»å¸«ã®ã€2024å¹´1æœˆã®è¨ºç™‚ä»¶æ•°ã¨ã€å‡¦æ–¹ã—ãŸè–¬å‰¤ã®ç¨®é¡žæ•°ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚

2. å†…ç§‘ç³»ã®è¨ºç™‚ï¼ˆprimaryãŒ"å†…ç§‘"ã§å§‹ã¾ã‚‹ï¼‰ã«ã¤ã„ã¦ã€æ‚£è€…ã®å¹´ä»£åˆ¥ï¼ˆ10ä»£ã€20ä»£...ï¼‰ã®è¨ºç™‚ä»¶æ•°ã¨ã€æœ€ã‚‚å¤šãå‡¦æ–¹ã•ã‚ŒãŸè–¬å‰¤TOP3ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ãã®éš›ã€å‡¦æ–¹ç®‹ãŒå­˜åœ¨ã—ãªã„è¨ºç™‚ã‚‚ä»¶æ•°ã«ã¯å«ã‚ã¦ãã ã•ã„ã€‚

3. éŽåŽ»ã«ã€Œé«˜è¡€åœ§ã€ã®æ—¢å¾€æ­´ãŒã‚ã‚‹æ‚£è€…ã®ã€ç›´è¿‘3å›žã®è¨ºç™‚è¨˜éŒ²ã«ã¤ã„ã¦ã€è¨ºæ–­åã¨å‡¦æ–¹è–¬ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§å–å¾—ã—ã¦ãã ã•ã„ã€‚

æœŸå¾…ã•ã‚Œã‚‹å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆï¼š
- JSONæ“ä½œã®é©åˆ‡ãªä½¿ç”¨
- çµåˆã®æœ€é©åŒ–ï¼ˆINNER/LEFT JOINã®ä½¿ã„åˆ†ã‘ï¼‰
- CTEã‚’ä½¿ç”¨ã—ãŸæ®µéšŽçš„ãªå‡¦ç†
- é›†è¨ˆã¨é †ä½ä»˜ã‘ã®çµ„ã¿åˆã‚ã›
- NULLå€¤ã®é©åˆ‡ãªå‡¦ç†

ãªãŠã€ä¸Šè¨˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ãŠã‚Šã€å„ã‚«ãƒ©ãƒ ã®NULLåˆ¶ç´„ã‚„ä¸€æ„æ€§åˆ¶ç´„ã¯é©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

ã“ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€JSONå‡¦ç†ã€è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆã€Windowé–¢æ•°ã®ä½¿ç”¨ãªã©ã€ã“ã‚Œã¾ã§ã®å­¦ç¿’å†…å®¹ã‚’ç·åˆçš„ã«æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

1. å„åŒ»å¸«ã®å°‚é–€åˆ†é‡Žã«ã€Œæ¶ˆåŒ–å™¨ç§‘ã€ã‚’å«ã‚€åŒ»å¸«ã®ã€2024å¹´1æœˆã®è¨ºç™‚ä»¶æ•°ã¨ã€å‡¦æ–¹ã—ãŸè–¬å‰¤ã®ç¨®é¡žæ•°ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚

--ç§ã®è§£ç­”
with record_stats as (
    select 
        d.doctor_id,
        count(m.record_id) as records
    from
        doctors d
        inner join medical_records m on m.doctor_id = d.doctor_id
    where
        date_format(m.visit_date,'%Y-%m')='2024-01'
        and json_contains(d.specialties,'"æ¶ˆåŒ–å™¨ç§‘"')
    group by
        d.doctor_id
),
medicine_stats as (
    select
        d.name,
        d.doctor_id,
        count(distinct jt.name) as medicines
    from
        doctors d
        inner join medical_records m on m.doctor_id = d.doctor_id
        inner join prescriptions p on p.record_id = m.record_id
        inner join json_table(
            p.medicines,'$[*]'
            columns(name VARCHAR(255) PATH '$.name')          
        ) jt
    WHERE
    	date_format(m.visit_date,'%Y-%m')='2024-01'
    	and json_contains(d.specialties,'"æ¶ˆåŒ–å™¨ç§‘"')
    group by
        d.name,
        d.doctor_id
)
select
    ms.name,
    rs.records,
    ms.medicines
from
    medicine_stats ms
    inner join record_stats rs on rs.doctor_id = ms.doctor_id;

--å®Ÿè¡Œçµæžœ

|name|records|medicines|
|----|-------|---------|
|å±±ç”°å¤ªéƒŽ|4      |4        |
|éˆ´æœ¨èŠ±å­|3      |3        |
|ä½è—¤æ¬¡éƒŽ|1      |2        |

--AIã®è©•ä¾¡

ã‚ãªãŸã®è§£ç­”ã‚’æŽ¡ç‚¹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

## è©•ä¾¡ï¼š90/100ç‚¹

### è‰¯ã„ç‚¹ ðŸ‘
1. CTEã‚’ä½¿ç”¨ã—ã¦è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’é©åˆ‡ã«åˆ†å‰²ï¼ˆrecord_stats, medicine_statsï¼‰
2. JSON_CONTAINSã‚’ä½¿ç”¨ã—ã¦å°‚é–€åˆ†é‡Žã®åˆ¤å®šã‚’é©åˆ‡ã«å®Ÿè£…
3. JSON_TABLEã‚’ä½¿ç”¨ã—ã¦è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å±•é–‹
4. INNER JOINã®ä½¿ç”¨ãŒé©åˆ‡ï¼ˆã“ã®è¦ä»¶ã§ã¯å­˜åœ¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿å¿…è¦ï¼‰
5. GROUP BYã¨DISTINCTã‚’ä½¿ç”¨ã—ã¦æ­£ç¢ºãªé›†è¨ˆã‚’å®Ÿç¾

### æ”¹å–„ã®ä½™åœ° ðŸ”§
1. **æ—¥ä»˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†**
   ```sql
   -- ç¾åœ¨ã®å®Ÿè£…
   date_format(m.visit_date,'%Y-%m')='2024-01'
   
   -- ã‚ˆã‚ŠåŠ¹çŽ‡çš„ãªå®Ÿè£…æ¡ˆ
   visit_date >= '2024-01-01' AND visit_date < '2024-02-01'
   ```
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã§ãã‚‹å½¢å¼ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå‘ä¸Š

2. **åŒ»å¸«ã®çŠ¶æ…‹ç¢ºèª**
   ```sql
   -- è¿½åŠ ã™ã¹ãæ¡ä»¶
   AND d.status = 'active'
   ```
   - ç¾å½¹ã®åŒ»å¸«ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹æ¡ä»¶ãŒæœªæŒ‡å®š

3. **çµæžœã®ã‚½ãƒ¼ãƒˆ**
   ```sql
   -- è¿½åŠ ã™ã¹ã
   ORDER BY records DESC, name
   ```
   - çµæžœã®é †åºãŒæœªæŒ‡å®š

### å®Ÿè¡Œçµæžœã®æ­£ç¢ºæ€§ âœ…
- å–å¾—ã•ã‚ŒãŸçµæžœã¯æ­£ç¢º
- åŒ»å¸«ã”ã¨ã®è¨ºç™‚ä»¶æ•°ã¨å‡¦æ–¹è–¬å‰¤æ•°ãŒé©åˆ‡ã«è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹

### ç·è©•
éžå¸¸ã«ã‚ˆãæ§‹é€ åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã§ã€JSONæ“ä½œã¨JOINã®ç†è§£ãŒååˆ†ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ç‰¹ã«CTEã‚’ä½¿ç”¨ã—ãŸæ®µéšŽçš„ãªå‡¦ç†ã¨ã€JSON_TABLEã‚’ä½¿ç”¨ã—ãŸJSONé…åˆ—ã®å±•é–‹ãŒåŠ¹æžœçš„ã§ã™ã€‚å°ã•ãªæ”¹å–„ç‚¹ã¯ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªè¦ä»¶ã¯ååˆ†ã«æº€ãŸã—ã¦ã„ã¾ã™ã€‚

å¼•ãç¶šã2å•ç›®ã€3å•ç›®ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

--æ„Ÿæƒ³
json_containsã‚’åˆ©ç”¨ã™ã‚‹ã¨ã'"æ–‡å­—åˆ—"'ã¨ã„ã†ã‚ˆã†ã«ã—ãªã„ã¨å‹•ä½œã—ãªã‹ã£ãŸã€‚
    
json_contains ã§ã®æ–‡å­—åˆ—æ¯”è¼ƒã§ `'"æ¶ˆåŒ–å™¨ç§‘"'` ã®ã‚ˆã†ã«äºŒé‡å¼•ç”¨ç¬¦ãŒå¿…è¦ãªç†ç”±ã«ã¤ã„ã¦èª¬æ˜Žã—ã¾ã™ã€‚

ã“ã‚Œã¯JSONå½¢å¼ã®ä»•æ§˜ã«é–¢ä¿‚ã—ã¦ã„ã¾ã™ï¼š

1. **JSONã®æ–‡å­—åˆ—è¡¨ç¾**
   - JSONã§ã¯æ–‡å­—åˆ—ã¯å¿…ãšäºŒé‡å¼•ç”¨ç¬¦(`"`)ã§å›²ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™
   - ä¾‹ï¼š`["å†…ç§‘", "æ¶ˆåŒ–å™¨ç§‘"]` ã¯æœ‰åŠ¹ãªJSON
   - `['å†…ç§‘', 'æ¶ˆåŒ–å™¨ç§‘']` ã¯ç„¡åŠ¹ãªJSONï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯ä¸å¯ï¼‰

2. **json_containsã®å‹•ä½œ**
   - ç¬¬2å¼•æ•°ã¯æœ‰åŠ¹ãªJSONå€¤ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹
   - `json_contains(specialties, 'æ¶ˆåŒ–å™¨ç§‘')` â†’ å¤±æ•—
     - `'æ¶ˆåŒ–å™¨ç§‘'` ã¯å˜ãªã‚‹æ–‡å­—åˆ—ã§JSONã¨ã—ã¦ç„¡åŠ¹
   - `json_contains(specialties, '"æ¶ˆåŒ–å™¨ç§‘"')` â†’ æˆåŠŸ
     - `'"æ¶ˆåŒ–å™¨ç§‘"'` ã¯ `"æ¶ˆåŒ–å™¨ç§‘"` ã¨ã„ã†JSONæ–‡å­—åˆ—ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã‚‹

å…·ä½“ä¾‹ï¼š
```sql
-- æ­£ã—ã„ä½¿ç”¨æ–¹æ³•
json_contains(specialties, '"æ¶ˆåŒ–å™¨ç§‘"')

-- é–“é•ã£ãŸä½¿ç”¨æ–¹æ³•
json_contains(specialties, 'æ¶ˆåŒ–å™¨ç§‘')  -- JSONã¨ã—ã¦ç„¡åŠ¹
```

ã“ã®ãŸã‚ã€JSONé…åˆ—å†…ã®æ–‡å­—åˆ—ã‚’æ¤œç´¢ã™ã‚‹å ´åˆã¯ã€å¿…ãšæ¤œç´¢æ–‡å­—åˆ—ã‚’äºŒé‡å¼•ç”¨ç¬¦ã§å›²ã¿ã€ãã‚Œå…¨ä½“ã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

2. å†…ç§‘ç³»ã®è¨ºç™‚ï¼ˆprimaryãŒ"å†…ç§‘"ã§å§‹ã¾ã‚‹ï¼‰ã«ã¤ã„ã¦ã€æ‚£è€…ã®å¹´ä»£åˆ¥ï¼ˆ10ä»£ã€20ä»£...ï¼‰ã®è¨ºç™‚ä»¶æ•°ã¨ã€æœ€ã‚‚å¤šãå‡¦æ–¹ã•ã‚ŒãŸè–¬å‰¤TOP3ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ãã®éš›ã€å‡¦æ–¹ç®‹ãŒå­˜åœ¨ã—ãªã„è¨ºç™‚ã‚‚ä»¶æ•°ã«ã¯å«ã‚ã¦ãã ã•ã„ã€‚

--ã¾ãšå¹´ä»£ã‚’ã¨ã£ã¦ãã‚‹å®Ÿé¨“
    select
        p.patient_id,
        concat((timestampdiff(year,p.birth_date,curdate()) DIV 10)*10,'ä»£') as age_group
    from
        patients p;

|patient_id|age_group|
|----------|---------|
|1         |30ä»£      |
|2         |30ä»£      |
|3         |20ä»£      |
|4         |40ä»£      |
|5         |20ä»£      |
|6         |30ä»£      |

--ã†ã¾ãè¨€ã£ãŸ ã“ã‚Œã‚’cteã¨ã—ã¦ä½¿ãŠã†ã€‚


with age_calc as (
    select
        p.patient_id,
        concat((timestampdiff(year,p.birth_date,curdate()) DIV 10)*10,'ä»£') as age_group
    from
        patients p
),
record_stats as (
    select
        ac.age_group,
        count(mr.record_id) as records
    from
        age_calc ac
        inner join medical_records mr on mr.patient_id = ac.patient_id
    group by
        ac.age_group
),
medicine_stats as (
    select
        ac.age_group,
        pjt.medicine_name,
        sum(cast(replace(pjt.medicine_amount,'mg','')as unsigned)) as total_amount
    from
        age_calc ac
        inner join medical_records mr on mr.patient_id = ac.patient_id
        inner join prescriptions p on p.record_id = mr.record_id
        inner join json_table(
            p.medicines,
            '$[*]' columns(
                medicine_name varchar(100) path '$.name',
                medicine_amount varchar(20) path '$.amount'
            
             )
        ) as pjt
    group by
        ac.age_group,
        pjt.medicine_name
),
medicine_ranks as (
    select
        age_group,
        medicine_name,
        rank() over (partition by age_group order by total_amount desc) as rank_in_age_group
    from
        medicine_stats
)
select
    rs.age_group,
    rs.records,
    group_concat(mr.medicine_name)
from
    record_stats rs
    inner join medicine_ranks mr
    on rs.age_group = mr.age_group
where
    mr.rank_in_age_group <= 3
group by
    rs.age_group,
    rs.records;
    

--å®Ÿè¡Œçµæžœ
|age_group|records|group_concat(mr.medicine_name)|
|---------|-------|------------------------------|
|20ä»£      |4      |ãƒ¬ãƒãƒŸãƒ”ãƒ‰,ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³,ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³          |
|30ä»£      |6      |ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³,ãƒ¬ãƒãƒŸãƒ”ãƒ‰,ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³           |
|40ä»£      |2      |ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³,ã‚¢ãƒˆãƒ«ãƒã‚¹ã‚¿ãƒãƒ³,ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³        |



--AIã®æŽ¡ç‚¹
ã‚ãªãŸã®è§£ç­”ã‚’æŽ¡ç‚¹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

## è©•ä¾¡ï¼š85/100ç‚¹

### è‰¯ã„ç‚¹ ðŸ‘
1. CTEã‚’ä½¿ç”¨ã—ã¦è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’è«–ç†çš„ã«åˆ†å‰²
2. å¹´ä»£è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé©åˆ‡ï¼ˆDIV 10ã‚’ä½¿ç”¨ï¼‰
3. JSON_TABLEã‚’ä½¿ç”¨ã—ã¦è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå±•é–‹
4. Windowé–¢æ•°ï¼ˆRANKï¼‰ã‚’ä½¿ç”¨ã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ã‘
5. GROUP_CONCATã§ã®è–¬å‰¤åã®çµåˆ

### æ”¹å–„ãŒå¿…è¦ãªç‚¹ ðŸ”§

1. **å†…ç§‘ç³»è¨ºç™‚ã®æ¡ä»¶ãŒæœªå®Ÿè£…**->å®Œå…¨ã«å¿˜ã‚Œã¦ã„ãŸ
```sql
-- medical_recordsã®çµåˆæ™‚ã«è¿½åŠ ã™ã¹ãæ¡ä»¶
WHERE json_extract(mr.diagnosis, '$.primary') LIKE 'å†…ç§‘%'
```

2. **å‡¦æ–¹ç®‹ãªã—ã®è¨ºç™‚ã‚‚å«ã‚ã‚‹å¿…è¦æ€§**ãƒ¼ï¼žå¿˜ã‚Œã¦ã„ãŸ
```sql
-- INNERã‚’LEFT JOINã«å¤‰æ›´
LEFT JOIN prescriptions p ON p.record_id = mr.record_id
```

3. **è–¬å‰¤ã®é›†è¨ˆæ–¹æ³•**ãƒ¼ï¼žã“ã‚Œã¯è¦ä»¶ãŒä¸æ˜Žçž­ãªã®ãŒæ‚ªã„
```sql
-- mgå˜ä½ã§ã®é›†è¨ˆã¯è¦ä»¶å¤–
-- å‡¦æ–¹å›žæ•°ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã™ã‚‹ã®ãŒé©åˆ‡
COUNT(*) as prescription_count  -- ç¾åœ¨ã®SUM(...)ã®ä»£ã‚ã‚Š
```

4. **çµæžœã®æ•´å½¢**
```sql
-- GROUP_CONCATã®æ•´å½¢
GROUP_CONCAT(mr.medicine_name ORDER BY mr.rank_in_age_group)
-- ã¾ãŸã¯
JSON_ARRAYAGG(mr.medicine_name) 
```

### ææ¡ˆã•ã‚Œã‚‹æ”¹å–„ç‰ˆ ðŸ”„
```sql
with age_calc as (
    select
        p.patient_id,
        concat((timestampdiff(year,p.birth_date,curdate()) DIV 10)*10,'ä»£') as age_group
    from
        patients p
),
record_stats as (
    select
        ac.age_group,
        count(mr.record_id) as records
    from
        age_calc ac
        inner join medical_records mr on mr.patient_id = ac.patient_id
    where
        json_extract(mr.diagnosis, '$.primary') LIKE 'å†…ç§‘%'
    group by
        ac.age_group
),
medicine_stats as (
    select
        ac.age_group,
        pjt.medicine_name,
        count(*) as prescription_count
    from
        age_calc ac
        inner join medical_records mr on mr.patient_id = ac.patient_id
        left join prescriptions p on p.record_id = mr.record_id
        cross join json_table(
            p.medicines,
            '$[*]' columns(
                medicine_name varchar(100) path '$.name'
            )
        ) as pjt
    where
        json_extract(mr.diagnosis, '$.primary') LIKE 'å†…ç§‘%'
    group by
        ac.age_group,
        pjt.medicine_name
)
-- ä»¥ä¸‹åŒæ§˜
```

### ç·è©•
åŸºæœ¬çš„ãªã‚¯ã‚¨ãƒªã®æ§‹é€ ã¯éžå¸¸ã«è‰¯ãã€CTEã®ä½¿ç”¨ã‚„é›†è¨ˆã®æ‰‹æ³•ã¯é©åˆ‡ã§ã™ã€‚ä¸»ãªæ”¹å–„ç‚¹ã¯ï¼š

1. å†…ç§‘ç³»è¨ºç™‚ã®æ¡ä»¶ã®è¿½åŠ 
2. LEFT JOINã®ä½¿ç”¨ã«ã‚ˆã‚‹æœªå‡¦æ–¹ã®è¨ºç™‚ã®åŒ…å«
3. é›†è¨ˆæ–¹æ³•ã®è¦‹ç›´ã—ï¼ˆmgå˜ä½ã§ã¯ãªãå‡¦æ–¹å›žæ•°ï¼‰

ã“ã‚Œã‚‰ã®ç‚¹ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè¦ä»¶ã«å³ã—ãŸçµæžœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

JSONæ“ä½œã¨Windowé–¢æ•°ã®ç†è§£ã¯ååˆ†ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒã€è¦ä»¶ã®ç´°ã‹ã„éƒ¨åˆ†ã«ã‚ˆã‚Šæ³¨æ„ã‚’æ‰•ã†ã¨ã€ã‚ˆã‚Šå®Œç’§ãªå®Ÿè£…ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚





--å•é¡Œï¼“ã®è©³ç´°èª¬æ˜Ž
æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›å½¢å¼ã‚’å…·ä½“çš„ã«ç¤ºã—ã¾ã™ï¼š

```
patient_name    visit_date    diagnoses                    prescribed_medicines
é«˜æ©‹å„ªå­        2024-01-25    ["å†…ç§‘æ¤œè¨º", "é«˜è¡€åœ§"]        ["ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg", "ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg"]
é«˜æ©‹å„ªå­        2024-01-15    ["å†…ç§‘æ¤œè¨º", "é«˜è¡€åœ§"]        ["ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg"]
é«˜æ©‹å„ªå­        2024-01-05    ["å†…ç§‘æ¤œè¨º", "è»½åº¦é«˜è¡€åœ§"]    ["ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg", "ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg"]
å°æž—ã•ãã‚‰      2024-01-20    ["å†…ç§‘æ¤œè¨º", "é«˜è¡€åœ§"]        ["ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg", "ã‚¾ãƒ«ãƒ”ãƒ‡ãƒ  5mg"]
å°æž—ã•ãã‚‰      2024-01-08    ["å†…ç§‘æ¤œè¨º", "é«˜è¡€åœ§"]        ["ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg", "ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³ 20mg"]
... 
```

è¦ä»¶ã®ãƒã‚¤ãƒ³ãƒˆï¼š

1. **æ‚£è€…ã®æŠ½å‡º**
   - medical_historyã®JSONã‹ã‚‰ã€Œé«˜è¡€åœ§ã€ã®æ—¢å¾€æ­´ãŒã‚ã‚‹æ‚£è€…ã‚’ç‰¹å®š
   - æ‚£è€…åã‚‚è¡¨ç¤º

2. **ç›´è¿‘3å›žã®è¨ºç™‚è¨˜éŒ²**
   - å„æ‚£è€…ã«ã¤ã„ã¦ã€visit_dateã®é™é †ã§3ä»¶ã¾ã§
   - Windowé–¢æ•°ï¼ˆROW_NUMBERï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æƒ³å®š

3. **è¨ºæ–­å†…å®¹**
   - diagnosisã‹ã‚‰primaryã¨secondaryã‚’é…åˆ—å½¢å¼ã§è¡¨ç¤º
   - JSON_ARRAYé–¢æ•°ã¾ãŸã¯JSON_ARRAYAGGã®ä½¿ç”¨ã‚’æƒ³å®š

4. **å‡¦æ–¹è–¬**
   - medicinesã‹ã‚‰è–¬å‰¤åã¨ç”¨é‡ã‚’çµ„ã¿åˆã‚ã›ã¦é…åˆ—å½¢å¼ã§è¡¨ç¤º
   - å‡¦æ–¹ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¡¨ç¤º

ã“ã®å½¢å¼ã§ã€é«˜è¡€åœ§æ‚£è€…ã®è¨ºç™‚å±¥æ­´ã¨å‡¦æ–¹å†…å®¹ã‚’æ™‚ç³»åˆ—ã§ç¢ºèªã§ãã¾ã™ã€‚




--ã˜ã‚ƒã‚ã¨ã“ã†ã‹ãª

--ã¾ãšã€é«˜è¡€åœ§ã®æ—¢å¾€ãŒã‚ã‚‹æ‚£è€…ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„

SELECT * FROM patients
WHERE JSON_CONTAINS(medical_history , '{"condition": "é«˜è¡€åœ§"}');

ã“ã‚Œã§ã†ã¾ãã„ã£ãŸã€‚

|patient_id|name |birth_date|medical_history                                                                                |
|----------|-----|----------|-----------------------------------------------------------------------------------------------|
|1         |é«˜æ©‹å„ªå­ |1990-05-15|"[{\"year\": \"2020\", \"condition\": \"é«˜è¡€åœ§\"}, {\"year\": \"2021\", \"condition\": \"èƒƒç‚Ž\"}]"  |
|3         |å°æž—ã•ãã‚‰|1995-03-10|"[{\"year\": \"2022\", \"condition\": \"é«˜è¡€åœ§\"}, {\"year\": \"2023\", \"condition\": \"ä¸çœ ç—‡\"}]" |
|4         |åŠ è—¤å¥äºŒ |1978-12-03|"[{\"year\": \"2018\", \"condition\": \"é«˜è¡€åœ§\"}, {\"year\": \"2021\", \"condition\": \"é«˜è„‚è¡€ç—‡\"}]"|

--prescribed_medicineã®å–å¾—ãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€å®Ÿé¨“

SELECT
	p.prescription_id,
	json_arrayagg(concat(jt.name,' ',jt.amount)) as formatted_array
from
	prescriptions p,
	json_table(p.medicines,'$[*]'
		columns(
			name varchar(255) path '$.name',
			amount varchar(50) path '$.amount'
		)
	) as jt
group by
	p.prescription_id ;


|prescription_id|formatted_array                       |
|---------------|--------------------------------------|
|1              |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\"]"   |
|2              |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\"]"                    |
|3              |"[\"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\", \"ãƒ¬ãƒãƒŸãƒ”ãƒ‰ 100mg\"]"  |
|4              |"[\"ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³ 500mg\"]"                  |
|5              |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³ 20mg\"]"  |
|6              |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚¾ãƒ«ãƒ”ãƒ‡ãƒ  5mg\"]"     |
|7              |"[\"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\"]"                   |
|8              |"[\"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\", \"ãƒ¬ãƒãƒŸãƒ”ãƒ‰ 100mg\"]"  |
|9              |"[\"ãƒ©ãƒ³ã‚½ãƒ—ãƒ©ã‚¾ãƒ¼ãƒ« 15mg\", \"ãƒ¬ãƒãƒŸãƒ”ãƒ‰ 100mg\"]"|
|10             |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\"]"                    |
|11             |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³ 20mg\"]"  |
|12             |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚¢ãƒˆãƒ«ãƒã‚¹ã‚¿ãƒãƒ³ 10mg\"]" |




with patients_with_high_pressure as(
    select
        p.patient_id
        p.name
    from
        patients p
    where
        json_contains(p.medical_history, '{"condition":"é«˜è¡€åœ§"}')
),
ranked_records as (
    select
        pwhp.patient_id,
        pwhp.name as patient_name,
        mr.record_id,
        mr.visit_date,
        mr.diagnosis,
        row_number() over (partition by pwhp.patient_id order by mr.visit_date)  as row_num
    from
        patients_with_high_pressure pwhp
        inner join medical_records mr on mr.patient_id = pwhp.patient_id
        left join prescriptions pr on pr.record_id = mr.record_id
),
medicine_infos as (
    select
	    p.record_id,
	    json_arrayagg(concat(jt.name,' ',jt.amount)) as formatted_array
    from
	    prescriptions p,
	    json_table(p.medicines,'$[*]'
		    columns(
			    name varchar(255) path '$.name',
			    amount varchar(50) path '$.amount'
		    )
	    ) as jt
    group by
	    p.prescription_id
)
select
    rr.patient_name,
    rr.visit_date,
    json_merge_preserve(rr.diagnosis->'$.primary',rr.diagnosis->'$.secondary') as diagnosis,
    mi.formatted_array as medicine_info
from
    ranked_records rr
    left join medicine_infos mi on mi.record_id = rr.record_id
where
    rr.row_num <= 3;

--å®Ÿè¡Œçµæžœ

|patient_name|visit_date|diagnosis                      |medicine_info                        |
|------------|----------|-------------------------------|-------------------------------------|
|é«˜æ©‹å„ªå­        |2023-12-05|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\"]"          |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\"]"                   |
|é«˜æ©‹å„ªå­        |2024-01-05|"[\"å†…ç§‘æ¤œè¨º\", \"è»½åº¦é«˜è¡€åœ§\"]"        |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\"]"  |
|é«˜æ©‹å„ªå­        |2024-01-15|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\"]"          |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\"]"                   |
|å°æž—ã•ãã‚‰       |2023-12-15|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\"]"          |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³ 20mg\"]" |
|å°æž—ã•ãã‚‰       |2024-01-08|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\"]"          |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚ªãƒ«ãƒ¡ã‚µãƒ«ã‚¿ãƒ³ 20mg\"]" |
|å°æž—ã•ãã‚‰       |2024-01-20|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\", \"ä¸çœ ç—‡\"]" |"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚¾ãƒ«ãƒ”ãƒ‡ãƒ  5mg\"]"    |
|åŠ è—¤å¥äºŒ        |2023-12-20|"[\"å†…ç§‘æ¤œè¨º\", \"é«˜è¡€åœ§\", \"é«˜è„‚è¡€ç—‡\"]"|"[\"ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³ 5mg\", \"ã‚¢ãƒˆãƒ«ãƒã‚¹ã‚¿ãƒãƒ³ 10mg\"]"|
|åŠ è—¤å¥äºŒ        |2024-01-12|"[\"æ¶ˆåŒ–å™¨ç§‘æ¤œè¨º\"]"                 |"[\"ãƒ•ã‚¡ãƒ¢ãƒã‚¸ãƒ³ 20mg\"]"                  |

    
ã¯ã„ã€3ã¤ã®å•é¡Œã«å¯¾ã™ã‚‹ç·åˆçš„ãªæŽ¡ç‚¹ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ï¼š

## å•é¡Œ1: æ¶ˆåŒ–å™¨ç§‘åŒ»å¸«ã®è¨ºç™‚åˆ†æž
è©•ä¾¡: 90/100ç‚¹
- CTEã‚’ä½¿ç”¨ã—ãŸé©åˆ‡ãªæ§‹é€ åŒ–
- JSON_TABLEã§ã®è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã®å±•é–‹
- ä¸è¦ãªJOINã‚’é¿ã‘ãŸåŠ¹çŽ‡çš„ãªå®Ÿè£…
- æ”¹å–„ç‚¹ï¼šæ—¥ä»˜æ¡ä»¶ã¨ã‚½ãƒ¼ãƒˆé †ã®æœ€é©åŒ–

## å•é¡Œ2: å¹´ä»£åˆ¥ã®è¨ºç™‚ãƒ»å‡¦æ–¹åˆ†æž
è©•ä¾¡: 85/100ç‚¹
- å¹´ä»£è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé©åˆ‡
- Windowé–¢æ•°ã«ã‚ˆã‚‹è–¬å‰¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- GROUP_CONCATã§ã®çµæžœæ•´å½¢
- æ”¹å–„ç‚¹ï¼š
  * å†…ç§‘ç³»è¨ºç™‚ã®æ¡ä»¶æ¼ã‚Œ
  * å‡¦æ–¹ç®‹ãªã—ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®ä¸è¶³

## å•é¡Œ3: é«˜è¡€åœ§æ‚£è€…ã®è¨ºç™‚å±¥æ­´
è©•ä¾¡: 88/100ç‚¹
- JSONãƒ‡ãƒ¼ã‚¿ã®é©åˆ‡ãªå‡¦ç†
- ROW_NUMBERã§ã®å±¥æ­´åˆ¶é™
- çµæžœã®æ•´å½¢ãŒè¦‹ã‚„ã™ã„
- æ”¹å–„ç‚¹ï¼š
  * è¨ªå•æ—¥ã®ã‚½ãƒ¼ãƒˆé †ï¼ˆDESCå¿…è¦ï¼‰
  * æœ€çµ‚çš„ãªORDER BYå¥ã®è¿½åŠ 

## ç·åˆè©•ä¾¡: 88/100ç‚¹

### ç‰¹ã«å„ªã‚Œã¦ã„ã‚‹ç‚¹
1. JSONãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ãŒé©åˆ‡
2. CTEã‚’ä½¿ç”¨ã—ãŸè«–ç†çš„ãªæ§‹é€ åŒ–
3. Windowé–¢æ•°ã®åŠ¹æžœçš„ãªæ´»ç”¨
4. è¤‡é›‘ãªçµåˆã®é©åˆ‡ãªå®Ÿè£…

### æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ç‚¹
1. ã‚½ãƒ¼ãƒˆé †ã®æ˜Žç¤ºçš„ãªæŒ‡å®š
2. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆå‡¦æ–¹ç®‹ãªã—ç­‰ï¼‰ã®è€ƒæ…®
3. æ¤œç´¢æ¡ä»¶ã®å®Œå…¨æ€§

### æˆé•·ãŒè¦‹ã‚‰ã‚Œã‚‹ç‚¹
- JSONæ“ä½œã®ç†è§£åº¦ãŒå‘ä¸Š
- è¤‡é›‘ãªã‚¯ã‚¨ãƒªã®æ§‹é€ åŒ–èƒ½åŠ›
- Windowé–¢æ•°ã®æ´»ç”¨ç¯„å›²æ‹¡å¤§

å…¨ä½“ã¨ã—ã¦éžå¸¸ã«è‰¯å¥½ãªå®Ÿè£…ã§ã€å®Ÿå‹™ãƒ¬ãƒ™ãƒ«ã® SQL ã‚¹ã‚­ãƒ«ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ç´°ã‹ã„æœ€é©åŒ–ã®ä½™åœ°ã¯ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªè¦ä»¶ã¯ååˆ†ã«æº€ãŸã•ã‚Œã¦ã„ã¾ã™ã€‚
















































    
